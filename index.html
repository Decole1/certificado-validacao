<script>
  async function validarCertificado() {
    const chave = document.getElementById('input-chave').value.trim();
    const resultado = document.getElementById('resultado-validacao');
    const btnDownload = document.getElementById('btn-download');

    // Oculta o bot√£o no in√≠cio da fun√ß√£o
    btnDownload.style.display = 'none';

    if (!chave) {
      resultado.innerHTML = `
        <div style="padding: 15px; background: #ffe6e6; border: 2px solid #e57373; border-radius: 10px; color: #000;">
          <h2 style="color: #c62828;">‚ùå Por favor, insira uma chave v√°lida</h2>
        </div>
      `;
      return;
    }

    resultado.innerHTML = `
      <div style="padding: 30px; background: #333; border: 2px solid #888; border-radius: 18px;">
        <h3 style="color: #ddd;">üîé Verificando seu certificado...</h3>
      </div>
    `;

    try {
      const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vR9V30aB2G1oyLILEaD1rlo3H8rOARS-HfiHiT50ZBqCzLt6p4ijaGbfVgrTYDJS50TfOcMBTsOtuhb/pub?gid=1982449420&single=true&output=csv");
      const csv = await res.text();
      const linhas = csv.split("\n").slice(1);

      let encontrado = false;

      for (let linha of linhas) {
        const [nome, curso, data_emissao, chave_planilha] = linha.trim().split(",");

        if (chave_planilha === chave) {
          confetti();
          resultado.innerHTML = `
            <div style="padding: 30px; background: #2F4F4F; border: 2px solid #000000; border-radius: 16px; color: #fff;">
              <h2 style="color: #FFFAFA;">üéì A Decole Educacional te Parabeniza por investir em seu futuro conosco.</h2>
              <p style="font-weight: bold; font-size: 18px;">${nome}</p>
              <p>Concluiu o curso: <strong>${curso}</strong></p>
              <p>Data de conclus√£o: <strong>${data_emissao}</strong></p>
              <div style="margin-top: 20px;">
                <img src='https://cdn-icons-png.flaticon.com/512/190/190411.png' alt='Selo de autenticidade' width='80'/>
              </div>
            </div>
          `;

          // Checa se o arquivo existe antes de mostrar bot√£o
          const urlPDF = `certificados/${chave}.pdf`;
          const existe = await fetch(urlPDF, { method: 'HEAD' });

          if (existe.ok) {
            btnDownload.href = urlPDF;
            btnDownload.style.display = 'inline-block';
          } else {
            btnDownload.style.display = 'none';
          }

          encontrado = true;
          break;
        }
      }

      if (!encontrado) {
        resultado.innerHTML = `
          <div style="padding: 20px; background: #ffe6e6; border: 2px solid #e57373; border-radius: 12px; color: #000;">
            <h2 style="color: #c62828;">‚ùå Certificado n√£o encontrado</h2>
            <p>Verifique a chave digitada ou entre em contato com o emissor.</p>
          </div>
        `;
      }
    } catch (e) {
      resultado.innerHTML = `
        <div style="padding: 20px; background: #fffde7; border: 2px solid #fdd835; border-radius: 12px; color: #000;">
          <h2 style="color: #f9a825;">‚ö†Ô∏è Erro ao validar</h2>
          <p>Tente novamente em instantes.</p>
        </div>
      `;
    }
  }
</script>
